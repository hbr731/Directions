<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!-- <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyAhZta_RCHs4AFUSsG6SKn07WqdHOHBcUM&sensor=false&callback=initializeMap&libraries=places"></script> -->

    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>React App</title>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAhZta_RCHs4AFUSsG6SKn07WqdHOHBcUM&sensor=false&callback=initMap&libraries=places"
    ></script>

    <style type="text/css">
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map {
        height: 100%;
        float: left;
        width: 70%;
        height: 100%;
      }

      #directionspanel {
        margin-top: 10px;
        background-color: #ffee77;
        padding: 10px;
        overflow: scroll;
        height: 174px;
      }
    </style>


    <script>
      let latitude
      let longitude

      (function (exports) {

        function initMap() 
        {
          let initialPosition = { lat: 59.325, lng: 18.069 };

          var directionsRenderer = new google.maps.DirectionsRenderer(),
            directionsService = new google.maps.DirectionsService();
          
          var map = new google.maps.Map(document.getElementById("map"), {
            center: initialPosition,
            zoom: 15,
          });

          const marker = new google.maps.Marker({ map, position: initialPosition });

            // Get user's location
          if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(
              position => {
                console.log(`Lat: ${position.coords.latitude} Lng: ${position.coords.longitude}`);

                latitude = position.coords.latitude
                longitude = position.coords.longitude

                // Set marker's position.
                marker.setPosition({
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                });

                // Center map to user's position.
                map.panTo({
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                });
              },
              err => console.log(`Error (${err.code}): ${getPositionErrorMessage(err.code)}`)
            );
          } else {
            alert('Geolocation is not supported by your browser.');
          }
        
          directionsRenderer.setMap(map);
          document
            .getElementById("submit")
            .addEventListener("click", function () {
              calculateAndDisplayRoute(directionsService, directionsRenderer);
            });
        }


        function calculateAndDisplayRoute(
          directionsService,
          directionsRenderer
        ) {
          let waypts = [];
          let waypoints = document.getElementById("waypoints").value.split(',');

          for (let i = 0; i< waypoints.length; i++) {
            waypts.push({
              location:waypoints[i],
              stopover: true
            })
          }

          console.log(waypts);

          directionsService.route(
            {
              origin: new google.maps.LatLng(latitude, longitude),
              destination: new google.maps.LatLng(latitude, longitude),
              waypoints: waypts,
              optimizeWaypoints: true,
              travelMode: "DRIVING",
            },
            (result, status) => {
              if (status == "OK") {
                console.log(result);
                directionsRenderer.setDirections(result);
                var route = result.routes[0];
                var summaryPanel = document.getElementById("directionspanel");
                summaryPanel.innerHTML = "";
                for (var i = 0; i < route.legs.length; i++) {
                  var routeSegment = i + 1;
                  summaryPanel.innerHTML +=
                    "<b>Route Segment: " + routeSegment + "</b><br>";
                  summaryPanel.innerHTML +=
                    route.legs[i].start_address + " to ";
                  summaryPanel.innerHTML += route.legs[i].end_address + "<br>";
                  summaryPanel.innerHTML +=
                    route.legs[i].distance.text + "<br><br>";
                }
              } else {
                window.alert("Directions request failed due to " + status);
              }
            }
          );
        }
        exports.calculateAndDisplayRoute = calculateAndDisplayRoute;
        exports.initMap = initMap;
      })((this.window = this.window || {}));
    </script>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <input type="submit" id="submit" value="submit" />
    <div id="map"></div>
    <div id="directionspanel"></div>
    
  </body>
</html>
